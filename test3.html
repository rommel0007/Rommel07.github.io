<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Test de la Tercera Ley de Newton</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .question {
            margin-bottom: 20px;
        }
        .options {
            list-style: none;
            padding: 0;
        }
        .options li {
            padding: 5px;
            border: 1px solid #ccc;
            margin-top: 5px;
            cursor: pointer;
        }
        .options li.selected {
            background-color: #cce5ff;
        }
        .button {
            display: inline-block;
            margin: 10px 5px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }
        #result {
            font-weight: bold;
            margin-top: 20px;
        }
        #timer {
            font-size: 18px;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQQLMza2AXs-ybrho_VjGWbRIB7DcjBwo",
            authDomain: "base-de-datos-usuarios-433da.firebaseapp.com",
            projectId: "base-de-datos-usuarios-433da",
            storageBucket: "base-de-datos-usuarios-433da.appspot.com",
            messagingSenderId: "563969031549",
            appId: "1:563969031549:web:66c35b0e769d73b31d2014"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.firestore = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.doc = doc;
        window.setDoc = setDoc;

    </script>
</head>
<body>
    <header>
        <h1>Test de la Tercera Ley de Newton</h1>
        <div id="timer">Tiempo restante: 2:00</div>
        <button class="button" id="startButton">¡Realiza el intento!</button>
    </header>

    <div id="quiz"></div>
    <button class="button" id="finishBtn" style="display:none;">Finalizar</button>
    <div id="result"></div>

    <script type="module">
        const questions = [
            {
                question: "¿Qué establece la tercera ley de Newton?",
                options: [
                    "A toda acción corresponde una reacción igual y contraria",
                    "La fuerza es igual a la masa por la aceleración",
                    "La energía se conserva",
                    "La masa y la energía son equivalentes"
                ],
                answer: 0
            },
            {
                question: "Si empujas una pared, ¿qué fuerza experimentas según la tercera ley?",
                options: [
                    "Ninguna fuerza",
                    "Una fuerza igual y opuesta de la pared",
                    "Una fuerza menor que la aplicada",
                    "Una fuerza mayor que la aplicada"
                ],
                answer: 1
            },
            {
                question: "La tercera ley de Newton explica:",
                options: [
                    "Por qué los objetos en reposo permanecen en reposo",
                    "Por qué los objetos aceleran cuando se les aplica fuerza",
                    "Por qué los cohetes pueden impulsarse en el espacio",
                    "Por qué la energía se transfiere"
                ],
                answer: 2
            },
            {
                question: "Cuando un cohete expulsa gases hacia atrás, ¿qué sucede según la tercera ley?",
                options: [
                    "El cohete se detiene",
                    "Los gases vuelven al cohete",
                    "El cohete avanza hacia adelante",
                    "No hay reacción"
                ],
                answer: 2
            },
            {
                question: "¿Qué sucede con las fuerzas en una interacción entre dos cuerpos?",
                options: [
                    "Son fuerzas independientes",
                    "Son fuerzas iguales en magnitud y dirección",
                    "Son fuerzas iguales en magnitud y opuestas en dirección",
                    "Una fuerza domina a la otra"
                ],
                answer: 2
            }
        ];

        let selectedQuestions = [];
        let userAnswers = [];
        let quizStarted = false;
        let timerInterval;
        let secondsLeft = 120;
        let startTime;
        let currentUser;

        function getUsuario() {
            currentUser = localStorage.getItem('usuario');
            if (!currentUser) {
                alert('Por favor, inicie sesión para realizar el test.');
                window.location.href = 'index.html';
            }
            return currentUser;
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            document.getElementById('timer').textContent = `Tiempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            secondsLeft = 120;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                secondsLeft--;
                updateTimerDisplay();
                if (secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    finishQuiz(true);
                }
            }, 1000);
        }

        async function finishQuiz(timeOut = false) {
            clearInterval(timerInterval);
            document.getElementById('finishBtn').style.display = 'none';
            let score = 0;

            selectedQuestions.forEach((q, index) => {
                if (userAnswers[index] === q.answer) {
                    score += 2;
                }
            });

            const endTime = new Date();
            const elapsedTime = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            const timeSpent = `${minutes}m ${seconds}s`;

            const resultText = `Puntaje: ${score}/10\nTiempo usado: ${minutes}m ${seconds}s` +
                (timeOut ? "\nTiempo agotado" : "");

            document.getElementById('result').innerText = resultText;

            try {
                const usuario = getUsuario();
                const userDocRef = window.doc(window.firestore, "testResults", usuario);
                await window.setDoc(userDocRef, {
                    test3: {
                        score: score,
                        time: timeSpent,
                        timestamp: endTime.toISOString()
                    }
                }, { merge: true });

                alert('Resultados guardados correctamente. Puntaje: ' + score + ' Tiempo: ' + timeSpent);

            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
                alert('Error al guardar los resultados. Por favor, inténtelo de nuevo.');
            }
        }

        function startQuiz() {
            if (quizStarted) return;
            quizStarted = true;
            userAnswers = [];
            startTime = new Date();
            secondsLeft = 120;
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'inline-block';
            const quizContainer = document.getElementById('quiz');
            quizContainer.innerHTML = '';
            selectedQuestions = questions.sort(() => 0.5 - Math.random()).slice(0, 5);

            selectedQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                const questionTitle = document.createElement('h3');
                questionTitle.textContent = `Pregunta ${index + 1}: ${q.question}`;
                questionDiv.appendChild(questionTitle);

                const optionsList = document.createElement('ul');
                optionsList.className = 'options';

                q.options.forEach((option, i) => {
                    const optionItem = document.createElement('li');
                    optionItem.textContent = option;
                    optionItem.onclick = () => {
                        userAnswers[index] = i;
                        [...optionsList.children].forEach(li => li.classList.remove('selected'));
                        optionItem.classList.add('selected');
                    };
                    optionsList.appendChild(optionItem);
                });

                questionDiv.appendChild(optionsList);
                quizContainer.appendChild(questionDiv);
            });

            startTimer();
        }

        window.onload = () => {
            getUsuario();
            document.getElementById('startButton').addEventListener('click', startQuiz);
            document.getElementById('finishBtn').addEventListener('click', () => finishQuiz(false));
        };
    </script>
</body>
</html>

